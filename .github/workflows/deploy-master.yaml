name: Promote Candidate to Stable and Deploy

on:
  workflow_dispatch:

env:
  BACKEND_IMAGE: ditiocorporate/ditio.org-backend
  FRONTEND_IMAGE: ditiocorporate/ditio.org-frontend

jobs:
  promote-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 1 Pull latest candidate images
      - name: Pull candidate images
        run: |
          docker pull $BACKEND_IMAGE:candidate
          docker pull $FRONTEND_IMAGE:candidate

      # 2 Retag as stable
      - name: Promote to stable
        run: |
          docker tag $BACKEND_IMAGE:candidate $BACKEND_IMAGE:stable
          docker tag $FRONTEND_IMAGE:candidate $FRONTEND_IMAGE:stable

          docker push $BACKEND_IMAGE:stable
          docker push $FRONTEND_IMAGE:stable

      # 3 Deploy to server via SSH
      - name: Deploy on server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            cd /srv/ditio   # <-- adjust to your compose directory

            # Make sure env uses stable
            sed -i 's/^BACKEND_TAG=.*/BACKEND_TAG=stable/' .env
            sed -i 's/^FRONTEND_TAG=.*/FRONTEND_TAG=stable/' .env

            docker compose pull
            docker compose up -d

            docker image prune -f